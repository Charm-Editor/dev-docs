"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[4063],{9994(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"architecture/ARCHITECTURE","title":"Charm Editor \u2013 Architectural Blueprint","description":"1. Vision","source":"@site/docs/architecture/ARCHITECTURE.md","sourceDirName":"architecture","slug":"/architecture/","permalink":"/dev-docs/docs/architecture/","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/architecture/ARCHITECTURE.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Introduction","permalink":"/dev-docs/docs/intro"},"next":{"title":"Data Flows","permalink":"/dev-docs/docs/architecture/DATA_FLOW"}}');var s=r(2615),l=r(7545);const t={},d="Charm Editor \u2013 Architectural Blueprint",c={},o=[{value:"1. Vision",id:"1-vision",level:2},{value:"2. High-Level Architecture",id:"2-high-level-architecture",level:2},{value:"3. apps/* (Runtimes)",id:"3-apps-runtimes",level:2},{value:"apps/web",id:"appsweb",level:3},{value:"apps/desktop",id:"appsdesktop",level:3},{value:"4. @charm-editor/core (Pure Domain)",id:"4-charm-editorcore-pure-domain",level:2},{value:"Structure",id:"structure",level:3},{value:"Examples",id:"examples",level:3},{value:"5. Communication Patterns",id:"5-communication-patterns",level:2},{value:"UI \u2192 Core",id:"ui--core",level:3},{value:"Core \u2192 Infra",id:"core--infra",level:3},{value:"Core \u2192 UI",id:"core--ui",level:3},{value:"6. @charm-editor/editor-engine",id:"6-charm-editoreditor-engine",level:2},{value:"Goal",id:"goal",level:3},{value:"Structure",id:"structure-1",level:3},{value:"Rule",id:"rule",level:3},{value:"7. @charm-editor/lsp-client",id:"7-charm-editorlsp-client",level:2},{value:"Responsibility",id:"responsibility",level:3},{value:"Features",id:"features",level:3},{value:"Depends on",id:"depends-on",level:3},{value:"8. glsl_analyzer (Zig)",id:"8-glsl_analyzer-zig",level:2},{value:"Role",id:"role",level:3},{value:"Modes",id:"modes",level:3},{value:"Contract",id:"contract",level:3},{value:"9. @charm-editor/file-system",id:"9-charm-editorfile-system",level:2},{value:"Responsibility",id:"responsibility-1",level:3},{value:"Interface",id:"interface",level:3},{value:"Implementations",id:"implementations",level:3},{value:"10. Collaboration (Future)",id:"10-collaboration-future",level:2},{value:"Engine",id:"engine",level:3},{value:"Scope",id:"scope",level:3},{value:"Isolation",id:"isolation",level:3},{value:"11. Data Flow Example (Edit \u2192 Compile)",id:"11-data-flow-example-edit--compile",level:2},{value:"12. Non-Negotiable Rules",id:"12-non-negotiable-rules",level:2},{value:"13. Phase Execution Order",id:"13-phase-execution-order",level:2},{value:"Phase 1",id:"phase-1",level:3},{value:"Phase 2",id:"phase-2",level:3},{value:"Phase 3",id:"phase-3",level:3},{value:"Phase 4",id:"phase-4",level:3},{value:"End",id:"end",level:2}];function a(e){const n={blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"charm-editor--architectural-blueprint",children:"Charm Editor \u2013 Architectural Blueprint"})}),"\n",(0,s.jsx)(n.h2,{id:"1-vision",children:"1. Vision"}),"\n",(0,s.jsx)(n.p,{children:"Charm Editor is a modular, cross-platform shader IDE.\r\nThe architecture is designed to:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Support Web + Electron without code duplication"}),"\n",(0,s.jsx)(n.li,{children:"Isolate business logic from UI and runtime"}),"\n",(0,s.jsx)(n.li,{children:"Allow future expansion (Live Share, WASM, Mobile, Plugins)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The system follows ",(0,s.jsx)(n.strong,{children:"Clean Architecture + Ports & Adapters"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"2-high-level-architecture",children:"2. High-Level Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:'flowchart TB\r\n\r\nsubgraph Apps["Applications (Runtimes)"]\r\n    Web["apps/web<br/>(Browser)"]\r\n    Desktop["apps/desktop<br/>(Electron)"]\r\nend\r\n\r\nsubgraph UI["Presentation"]\r\n    UIPkg["@charm-editor/ui<br/>React UI<br/>State Binding<br/>View Models"]\r\nend\r\n\r\nsubgraph Core["@charm-editor/core (Pure)"]\r\n    Domain["Domain Models"]\r\n    UseCases["Use Cases"]\r\n    Ports["Ports (Interfaces)"]\r\nend\r\n\r\nsubgraph Infra["Infrastructure (Adapters)"]\r\n    FS["File System Impl"]\r\n    LSP["LSP Client Impl"]\r\n    Runtime["Runtime APIs"]\r\nend\r\n\r\nsubgraph Engines["Editor Engines"]\r\n    Adapter["EditorAdapter"]\r\n    Monaco["Monaco"]\r\n    CM["CodeMirror"]\r\nend\r\n\r\nWeb --\x3e UIPkg\r\nDesktop --\x3e UIPkg\r\n\r\nUIPkg --\x3e UseCases\r\nUIPkg --\x3e Adapter\r\n\r\nAdapter --\x3e Monaco\r\nAdapter --\x3e CM\r\n\r\nUseCases --\x3e Domain\r\nUseCases -.-> Ports\r\n\r\nFS --\x3e Ports\r\nLSP --\x3e Ports\r\nRuntime --\x3e Ports'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"3-apps-runtimes",children:"3. apps/* (Runtimes)"}),"\n",(0,s.jsx)(n.h3,{id:"appsweb",children:"apps/web"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Responsibility"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Browser-only runtime"}),"\n",(0,s.jsx)(n.li,{children:"No Electron, no Node APIs"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Contains"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"React TS + tailwindcss"}),"\n",(0,s.jsx)(n.li,{children:"WebGPU / WebGL renderer"}),"\n",(0,s.jsx)(n.li,{children:"Web FS implementation (OPFS / File Picker)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Depends on"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"@charm-editor/ui"}),"\n",(0,s.jsx)(n.li,{children:"@charm-editor/core"}),"\n",(0,s.jsx)(n.li,{children:"@charm-editor/editor-engine"}),"\n",(0,s.jsx)(n.li,{children:"@charm-editor/file-system (Web impl)"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"appsdesktop",children:"apps/desktop"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Responsibility"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Electron runtime (Native IDE)"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\r\napps/desktop\r\n\u251c\u2500 main\r\n\u2502  \u251c\u2500 main.ts        # Electron main process\r\n\u2502  \u2514\u2500 preload.ts    # Secure IPC bridge\r\n\u251c\u2500 renderer          # React + Vite app\r\n\u2514\u2500 package.json\r\n\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Rules"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"main/ NEVER imports React"}),"\n",(0,s.jsx)(n.li,{children:"renderer NEVER imports electron directly"}),"\n",(0,s.jsx)(n.li,{children:"Communication only via preload IPC"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"4-charm-editorcore-pure-domain",children:"4. @charm-editor/core (Pure Domain)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Golden Rule"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\u274c No React",(0,s.jsx)(n.br,{}),"\n","\u274c No DOM",(0,s.jsx)(n.br,{}),"\n","\u274c No Electron",(0,s.jsx)(n.br,{}),"\n","\u274c No fs / process",(0,s.jsx)(n.br,{}),"\n","\u2705 Pure TypeScript"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"structure",children:"Structure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\r\ncore/\r\n\u251c\u2500 domain        # Entities, Value Objects\r\n\u251c\u2500 app           # Use Cases\r\n\u251c\u2500 infra         # Interfaces only (Ports)\r\n\u2514\u2500 presentation  # View Models (NO React)\r\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"examples",children:"Examples"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["domain:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"ShaderDocument"}),"\n",(0,s.jsx)(n.li,{children:"ShaderStage"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["app:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CompileShaderUseCase"}),"\n",(0,s.jsx)(n.li,{children:"OpenWorkspaceUseCase"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["infra (interfaces):","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"FileSystemPort"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"LspClientPort"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SnapshotStorePort"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"5-communication-patterns",children:"5. Communication Patterns"}),"\n",(0,s.jsx)(n.p,{children:"To maintain strict isolation, we follow these patterns:"}),"\n",(0,s.jsx)(n.h3,{id:"ui--core",children:"UI \u2192 Core"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use Cases"}),": UI invokes specific use cases (e.g., ",(0,s.jsx)(n.code,{children:"SaveFileUseCase.execute()"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"View Models"}),": UI observes Reactive View Models (built with pure TS) for state updates."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"core--infra",children:"Core \u2192 Infra"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Dependency Injection"}),": Core defines interfaces (",(0,s.jsx)(n.strong,{children:"Ports"}),"). Infrastructure provides implementations (",(0,s.jsx)(n.strong,{children:"Adapters"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Core ",(0,s.jsx)(n.strong,{children:"NEVER"})," knows about the concrete implementation (e.g., it doesn't know if it's saving to Electron FS or Web OPFS)."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"core--ui",children:"Core \u2192 UI"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Events / Observables"}),": Core emits events or updates shared state that the UI observes. No direct callbacks."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"6-charm-editoreditor-engine",children:"6. @charm-editor/editor-engine"}),"\n",(0,s.jsx)(n.h3,{id:"goal",children:"Goal"}),"\n",(0,s.jsx)(n.p,{children:"Abstract text editing away from Monaco / CodeMirror."}),"\n",(0,s.jsx)(n.h3,{id:"structure-1",children:"Structure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\r\neditor-engine/\r\n\u251c\u2500 core\r\n\u2502  \u251c\u2500 EditorAdapter.ts\r\n\u2502  \u251c\u2500 TextModel.ts\r\n\u2502  \u2514\u2500 Cursor.ts\r\n\u251c\u2500 engines\r\n\u2502  \u251c\u2500 monaco\r\n\u2502  \u2514\u2500 code-mirror\r\n\u2514\u2500 index.ts\r\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"rule",children:"Rule"}),"\n",(0,s.jsxs)(n.p,{children:["UI talks ONLY to ",(0,s.jsx)(n.code,{children:"EditorAdapter"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This allows:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CRDT sync"}),"\n",(0,s.jsx)(n.li,{children:"Headless editor"}),"\n",(0,s.jsx)(n.li,{children:"Engine swapping"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"7-charm-editorlsp-client",children:"7. @charm-editor/lsp-client"}),"\n",(0,s.jsx)(n.h3,{id:"responsibility",children:"Responsibility"}),"\n",(0,s.jsx)(n.p,{children:"Unified LSP communication layer."}),"\n",(0,s.jsx)(n.h3,{id:"features",children:"Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Transport abstraction:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"stdio (Electron)"}),"\n",(0,s.jsx)(n.li,{children:"socket / wasm (Web)"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"Typed JSON-RPC messages"}),"\n",(0,s.jsx)(n.li,{children:"No dependency on Monaco"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"depends-on",children:"Depends on"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"@charm-editor/shared-types"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"8-glsl_analyzer-zig",children:"8. glsl_analyzer (Zig)"}),"\n",(0,s.jsx)(n.h3,{id:"role",children:"Role"}),"\n",(0,s.jsx)(n.p,{children:"Single source of truth for GLSL intelligence."}),"\n",(0,s.jsx)(n.h3,{id:"modes",children:"Modes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CLI (format / parse)"}),"\n",(0,s.jsx)(n.li,{children:"LSP server (stdio / socket)"}),"\n",(0,s.jsx)(n.li,{children:"Future: WASM"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"contract",children:"Contract"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Communicates ONLY via LSP"}),"\n",(0,s.jsx)(n.li,{children:"Editor never parses GLSL itself"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"9-charm-editorfile-system",children:"9. @charm-editor/file-system"}),"\n",(0,s.jsx)(n.h3,{id:"responsibility-1",children:"Responsibility"}),"\n",(0,s.jsx)(n.p,{children:"Abstract file access."}),"\n",(0,s.jsx)(n.h3,{id:"interface",children:"Interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"interface FileSystem {\r\n  readFile(path: string): Promise<string>;\r\n  writeFile(path: string, content: string): Promise<void>;\r\n  watch(path: string): () => void;\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"implementations",children:"Implementations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"ElectronFileSystem"}),"\n",(0,s.jsx)(n.li,{children:"WebFileSystem"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"10-collaboration-future",children:"10. Collaboration (Future)"}),"\n",(0,s.jsx)(n.h3,{id:"engine",children:"Engine"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CRDT-based (Automerge)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"scope",children:"Scope"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"TextModel sync"}),"\n",(0,s.jsx)(n.li,{children:"Cursor sync"}),"\n",(0,s.jsx)(n.li,{children:"Preview state sync"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"isolation",children:"Isolation"}),"\n",(0,s.jsx)(n.p,{children:"All collaboration logic lives in:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"@charm-editor/collaboration\n"})}),"\n",(0,s.jsx)(n.p,{children:"No UI logic inside."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"11-data-flow-example-edit--compile",children:"11. Data Flow Example (Edit \u2192 Compile)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"User Types\r\n  \u2193\r\nEditorAdapter\r\n  \u2193\r\nTextModel\r\n  \u2193\r\nCompileShaderUseCase\r\n  \u2193\r\nLspClient\r\n  \u2193\r\nglsl_analyzer\r\n  \u2193\r\nDiagnostics\r\n  \u2193\r\nUI Problems Panel\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"12-non-negotiable-rules",children:"12. Non-Negotiable Rules"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"core must stay pure"}),"\n",(0,s.jsx)(n.li,{children:"UI never talks to infra directly"}),"\n",(0,s.jsx)(n.li,{children:"Electron APIs only in apps/desktop/main"}),"\n",(0,s.jsx)(n.li,{children:"Monaco is an implementation detail"}),"\n",(0,s.jsx)(n.li,{children:"glsl_analyzer is the only GLSL brain"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"13-phase-execution-order",children:"13. Phase Execution Order"}),"\n",(0,s.jsx)(n.h3,{id:"phase-1",children:"Phase 1"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"EditorAdapter + Monaco"}),"\n",(0,s.jsx)(n.li,{children:"LSP stdio integration"}),"\n",(0,s.jsx)(n.li,{children:"Basic WebGPU preview"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-2",children:"Phase 2"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"FileSystem abstraction"}),"\n",(0,s.jsx)(n.li,{children:"Workspace + Includes"}),"\n",(0,s.jsx)(n.li,{children:"Problems panel"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-3",children:"Phase 3"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Snapshots + Thumbnails"}),"\n",(0,s.jsx)(n.li,{children:"GPU profiler"}),"\n",(0,s.jsx)(n.li,{children:"Resource explorer"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-4",children:"Phase 4"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Live Share"}),"\n",(0,s.jsx)(n.li,{children:"Marketplace"}),"\n",(0,s.jsx)(n.li,{children:"Remote preview"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"end",children:"End"}),"\n",(0,s.jsx)(n.p,{children:"This blueprint is intentionally strict.\r\nBreaking rules early creates technical debt that kills IDE-scale projects."})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},7545(e,n,r){r.d(n,{R:()=>t,x:()=>d});var i=r(9471);const s={},l=i.createContext(s);function t(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);